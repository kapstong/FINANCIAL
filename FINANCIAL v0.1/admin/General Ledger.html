<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>General Ledger</title>
  <link rel="icon" type="image/png" href="logo2.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
const API = 'http://localhost:5050';
function authHeaders(){ const t = localStorage.getItem('token'); return t? {Authorization:'Bearer '+t}:{ }; }
async function api(path, opts={}) {
  const res = await fetch(API+path, { ...opts, headers:{ 'Content-Type':'application/json', ...authHeaders(), ...(opts.headers||{}) }});
  const json = await res.json(); if(!res.ok) throw new Error(json.error||'Request failed'); return json;
}
</script>

  <style>
    :root{
      --brand:#0f1c49; --brand-600:#0c173c; --brand-100:#e8ecf9;
      --ink:#000; --muted:#000; --ring:0 0 0 3px rgba(15,28,73,.15);
      --card-bg: rgba(255,255,255,.95); --card-border: rgba(226,232,240,.9);

      /* Watermark tuning */
      --wm-opacity:.08;   /* lighter=.06 / darker=.12 */
      --wm-max-w:900px;   /* absolute width cap */
      --wm-max-h:70vh;    /* vertical cap */
      --wm-scale:0.65;    /* ~65% of table width */
    }

    body{ background:#fff; color:var(--ink); }
    .bg-soft{
      background:
        radial-gradient(70% 70% at 0% 0%, var(--brand-100) 0%, transparent 60%),
        radial-gradient(60% 60% at 100% 0%, #eef2ff 0%, transparent 55%),
        linear-gradient(#fff,#fff);
    }

    /* Header / Navbar */
    .navbar{ background:var(--brand); color:#fff; }
    .navbar *{ color:#fff !important; }
    .nav-input{
      background:rgba(255,255,255,.18); border:1px solid rgba(255,255,255,.35);
      padding:.35rem .6rem; border-radius:.6rem; color:#fff !important;
    }
    .nav-input::placeholder{ color:#f1f5f9; }

    /* Cards / Buttons / Tabs */
    .card{ background:var(--card-bg); border-radius:14px; border:1px solid var(--card-border); box-shadow:0 6px 18px rgba(2,6,23,.04) }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.55rem .95rem; border-radius:.65rem; font-weight:600; color:#000 }
    .btn-brand{ background:var(--brand); color:#fff !important } .btn-brand:hover{ background:var(--brand-600) }
    .btn-soft{ background:#fff; border:1px solid var(--card-border) } .btn-soft:hover{ background:#f8fafc }
    .tab-pill{ padding:.4rem .8rem; border-radius:9999px; border:1px solid var(--card-border); font-weight:700; font-size:.9rem; color:#000 }
    .tab-pill.active{ background:var(--brand); color:#fff; border-color:var(--brand) }

    /* Sidebar */
    .sidebar-transition{ transition:transform .28s ease }
    .overlay{ display:none } .overlay.active{ display:block; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:40 }
    .sidebar-item{ display:flex; align-items:center; gap:.6rem; width:100%; padding:.5rem .75rem; border-radius:.6rem; color:#000 }
    .sidebar-item:hover{ background:#f8fafc }
    .sidebar-item.active{ background:rgba(15,28,73,.06); color:var(--brand); font-weight:700 }

    /* Table */
    th,td{ white-space:nowrap; }
    thead tr{ background:#f8fafc; }
    tbody tr:hover{ background:#f8fafc; }
    .empty-state{ border:2px dashed var(--card-border); border-radius:12px; padding:20px; text-align:center; color:#475569; }

    /* ===== PRINT (header + watermark centered on active table) ===== */
    .print-only{ display:none; }
    @media print{
      header,#contextBar,aside,.no-print,#toast{ display:none !important; }
      body{ background:#fff; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      .card{ box-shadow:none; border:0; }
      .print-only{ display:block !important; }
      thead{ display:table-header-group; }
      @page{ margin:16mm 14mm; }

      /* Print title block */
      .print-header{ border-bottom:1px solid #e5e7eb; margin-bottom:12px; padding-bottom:8px; position:relative; z-index:2; }
      .print-header .title{ font-size:18px; font-weight:800; }
      .print-header .sub{ font-size:12px; color:#334155; }
      .logo-line{ display:flex; align-items:center; gap:12px; }
      .logo-line img{ height:38px; width:auto; }

      /* Active table stays above watermark */
      .table-wrap, .table-wrap table{ position:relative; z-index:1; }

      /* Watermark centered in the table area */
      .table-wrap #printWM{
        display:block !important;
        position:absolute; inset:0; z-index:0; pointer-events:none;
        display:flex; align-items:center; justify-content:center;
      }
      .table-wrap #printWM img{
        width:clamp(260px, 50%, var(--wm-max-w));
        max-height:var(--wm-max-h);
        height:auto;
        opacity:var(--wm-opacity);
        filter:grayscale(12%);
      }
    }
  </style>
</head>
<body class="min-h-screen text-[15px] bg-soft">

  <!-- GLOBAL LOADER -->
  <div id="globalLoader" class="fixed inset-0 z-[100] hidden items-center justify-center bg-slate-900/20">
    <div class="flex flex-col items-center gap-3">
      <svg class="animate-spin h-10 w-10" viewBox="0 0 24 24" style="color:var(--brand)">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-sm">Loading‚Ä¶</p>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="fixed top-4 right-4 z-[120] hidden"></div>

  <!-- ===== HEADER ===== -->
  <header class="sticky top-0 z-50 border-b border-[var(--ring)] navbar backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-14 flex items-center gap-3">
      <button id="openSidebar" class="md:hidden p-2 rounded hover:bg-white/10" aria-label="Open menu">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h10"/></svg>
      </button>

      <!-- Brand -->
      <a href="dashboard.html" class="flex items-center gap-3">
        <img src="logo2.png" alt="ATI√âRA" class="h-8 w-auto sm:h-10" draggable="false">
        <span class="font-extrabold tracking-wide text-lg">ATIERA</span>
      </a>

      <!-- Search (global) -->
      <div class="ml-auto flex items-center gap-2">
        <input id="searchInput" placeholder="Search modules, cards, rows‚Ä¶" class="nav-input text-sm w-72 outline-none"/>
      </div>

      <!-- Live date/time -->
      <div id="clockWrap" class="hidden md:flex items-center gap-2 mr-1 select-none">
        <span id="liveDate" class="text-sm"></span>
        <button id="liveTime" class="text-sm font-mono px-2 py-0.5 rounded border border-white/30 bg-white/10"
                title="Click to toggle 12/24-hour time"></button>
      </div>

      <!-- Profile -->
      <div class="relative">
        <button id="profileBtn" class="p-2 rounded hover:bg-white/10 flex items-center gap-2" title="Account">
          <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-white/15 border border-white/30">üë§</span>
        </button>
        <div id="profileMenu" class="hidden absolute right-0 mt-2 w-56 bg-black rounded-lg shadow-xl border border-[var(--card-border)] overflow-hidden text-[var(--ink)]">
          <div class="px-4 py-2 text-xs text-slate-500 border-b border-[var(--card-border)] md:hidden">
            <span id="liveDateMobile"></span> ‚Ä¢ <span id="liveTimeMobile" class="font-mono"></span>
        </div>
<a href="#" class="block px-4 py-2 text-black hover:bg-slate-900">Settings</a>
<a href="#" class="block px-4 py-2 text-black hover:bg-slate-900">Profile</a>
<a href="#" class="block px-4 py-2 text-black hover:bg-slate-900">My Messages</a>
<a href="#" class="block px-4 py-2 text-black hover:bg-slate-900">Lock Screen</a>
<a href="login.html?logout=1" class="btn">Logout</a></div>

      </div>
    </div>
  </header>

  <!-- NAVBAR SUB-MODULE TABS -->
  <div id="contextBar" class="sticky top-14 z-40 border-b border-[var(--ring)] bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-12 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="font-semibold text-slate-800">General Ledger</span>
      </div>
      <nav id="contextTabs" class="flex flex-wrap gap-2">
        <a class="tab-pill" href="#General%20Ledger/gl-je">Journal Entries</a>
        <a class="tab-pill" href="#General%20Ledger/gl-tb">Trial Balance</a>
        <a class="tab-pill" href="#General%20Ledger/gl-ledger">Ledger Report</a>
      </nav>
    </div>
  </div>

  <!-- PRINT HEADER (print-only) -->
  <div id="printHeader" class="print-only px-2">  
    <div class="print-header">
      <div class="logo-line">
        <img src="logo.png" alt="ATIERA logo">
        <div> 
          <div class="title" id="printTitle">ATIERA ‚Äî General Ledger ‚Äî Journal Entries</div>
          <div class="sub">Prepared <span id="printWhen"></span> ‚Ä¢ <span id="printContext">All records</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PRINT WATERMARK (logo only; moved to active table on print) -->
  <div id="printWM" class="print-only" aria-hidden="true">
    <img src="logo.png" alt="Logo watermark">
  </div>

  <!-- LAYOUT -->
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 grid grid-cols-1 md:grid-cols-[240px_1fr] gap-6 py-6">
    <div id="overlay" class="overlay"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed md:static left-0 top-14 md:top-auto w-64 md:w-full h-[calc(100vh-56px)] md:h-auto bg-white border-r border-[var(--ring)] sidebar-transition -translate-x-full md:translate-x-0 z-50 overflow-y-auto">
      <nav class="p-3 space-y-1">
        <div class="text-[11px] uppercase tracking-widest text-slate-500 px-2 pt-2 pb-1">Navigation</div>
        <a class="sidebar-item" href="dashboard.html"><span>üè†</span><span>Dashboard</span></a>

        <a class="sidebar-item active" href="General Ledger.html"><span>üìò</span><span>General Ledger</span></a>
        <a class="sidebar-item" href="Accounts Receivable.html"><span>üí≥</span><span>Accounts Receivable</span></a>
        <a class="sidebar-item" href="Collections.html"><span>üßæ</span><span>Collections</span></a>
        <a class="sidebar-item" href="Accounts Payable.html"><span>üìÑ</span><span>Accounts Payable</span></a>
        <a class="sidebar-item" href="Disbursement.html"><span>üí∏</span><span>Disbursement</span></a>
        <a class="sidebar-item" href="Budget Management.html"><span>üìä</span><span>Budget Management</span></a>
        <a class="sidebar-item" href="Reports.html"><span>üìë</span><span>Reports</span></a>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="space-y-6">
      <section id="contentHost" class="space-y-6"></section>
    </main>
  </div>

  <script>
    /* ===== Tiny helpers ===== */
    const $=(s,r=document)=>r.querySelector(s), $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const fmtMoney = (n,curr='PHP') => Number(n).toLocaleString(undefined,{style:'currency',currency:curr});

    /* ===== Sample DATA per tab ===== */
    const DATA = {
      'gl-je': [
        {date:'2025-08-12', ref:'#0005', desc:'Supplies expense ‚Äî housekeeping', debit:310.00, credit:0},
        {date:'2025-08-09', ref:'#0004', desc:'Utilities expense ‚Äî electric bill', debit:920.35, credit:0},
        {date:'2025-08-05', ref:'#0003', desc:'F&B revenue ‚Äî breakfast buffet', debit:0, credit:1330.00},
        {date:'2025-08-03', ref:'#0002', desc:'Room revenue ‚Äî walk-in guests', debit:0, credit:2450.50},
        {date:'2025-08-01', ref:'#0001', desc:'Opening balance capitalization', debit:1000.00, credit:0},
      ],
      'gl-tb': [
        {account:'Cash', debit:54000, credit:0},
        {account:'Accounts Receivable', debit:12000, credit:0},
        {account:'Accounts Payable', debit:0, credit:8000},
        {account:'Revenue', debit:0, credit:3880.50},
        {account:'Utilities Expense', debit:920.35, credit:0},
        {account:'Supplies Expense', debit:310.00, credit:0},
      ],
      'gl-ledger': [
        {date:'2025-08-01', ref:'LED-001', desc:'Cash ‚Äî debits/credits rollup', debit:54000.00, credit:0, balance:54000.00},
        {date:'2025-08-01', ref:'LED-002', desc:'AR ‚Äî guest folios', debit:12000.00, credit:0, balance:66000.00},
        {date:'2025-08-01', ref:'LED-003', desc:'AP ‚Äî suppliers', debit:0, credit:8000.00, balance:58000.00},
      ]
    };

    /* ===== Loader & Toast (optional UX) ===== */
    const Loader=(()=>{const el=$('#globalLoader');let on=false,t0=0;const MIN=250;
      function show(){if(on) return; on=true;t0=performance.now();el.classList.remove('hidden');el.classList.add('flex');}
      function hide(){if(!on) return;const d=Math.max(0,MIN-(performance.now()-t0));setTimeout(()=>{el.classList.add('hidden');el.classList.remove('flex');on=false;},d);}
      async function wrap(job){show();try{return typeof job==='function'?await job():await job;}finally{hide();}}
      return{show,hide,wrap};
    })();
    const Toast=(msg,ms=1500)=>{const t=$('#toast'); t.innerHTML=`<div class="toast-card bg-white border border-[var(--card-border)] rounded-md px-3 py-2 shadow">${msg}</div>`; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), ms);};

    /* ===== Sidebar, profile, theme, clock ===== */
    const overlay=$('#overlay'), sidebar=$('#sidebar');
    $('#openSidebar')?.addEventListener('click', ()=>{sidebar.classList.remove('-translate-x-full'); overlay.classList.add('active');});
    overlay?.addEventListener('click', ()=>{sidebar.classList.add('-translate-x-full'); overlay.classList.remove('active');});
    const pBtn=$('#profileBtn'), pMenu=$('#profileMenu');
    pBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); pMenu.classList.toggle('hidden');});
    document.addEventListener('click', (e)=>{ if(pBtn && pMenu && !pBtn.contains(e.target) && !pMenu.contains(e.target)) pMenu.classList.add('hidden'); });
    $('#darkModeToggle')?.addEventListener('click', ()=>{ document.documentElement.classList.toggle('dark'); document.body.classList.toggle('bg-soft'); });
    (function clock(){
      const t=$('#liveTime'), d=$('#liveDate'), tm=$('#liveTimeMobile'), dm=$('#liveDateMobile'); let is24=localStorage.getItem('fmt24')==='1';
      const fD=n=>new Intl.DateTimeFormat(undefined,{year:'numeric',month:'short',day:'2-digit',weekday:'short'}).format(n);
      const fT=n=>new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:!is24}).format(n);
      function tick(){const n=new Date(); if(d) d.textContent=fD(n); if(t) t.textContent=fT(n); if(dm) dm.textContent=fD(n); if(tm) tm.textContent=fT(n);}
      t?.addEventListener('click',()=>{is24=!is24; localStorage.setItem('fmt24',is24?'1':'0'); tick();});
      tick(); setInterval(tick,1000); $('#clockWrap')?.classList.remove('hidden');
    })();

    /* ===== Tabs (hash-based like your original) ===== */
    const GL_TABS = [
      { id:'gl-je', label:'Journal Entries' },
      { id:'gl-tb', label:'Trial Balance' },
      { id:'gl-ledger', label:'Ledger Report' },
    ];

    function decodeHash(){
      const h=(location.hash||'#General%20Ledger/gl-je').slice(1);
      const [mod, tab]=h.split('/');
      return { module: decodeURIComponent(mod||'General Ledger'), tab: decodeURIComponent(tab||'gl-je') };
    }

    function markActiveTab(tabId){
      $$('#contextTabs .tab-pill').forEach(a=>{
        a.classList.toggle('active', a.getAttribute('href') === `#General%20Ledger/${tabId}`);
      });
    }

    /* ===== Search state ===== */
    let STATE = { q:'', from:'', to:'', currency:'PHP' };
    const searchEl=$('#globalSearch'), clearBtn=$('#clearSearch');
    function setSearch(q){
      STATE.q = (q||'').trim().toLowerCase();
      if (searchEl) searchEl.value = q||'';
      clearBtn?.classList.toggle('hidden', !STATE.q);
      renderView(decodeHash().tab);
    }
    function wireSearch(){
      if(!searchEl) return;
      let t; searchEl.addEventListener('input', (e)=>{
        const v = e.target.value || '';
        clearTimeout(t); t = setTimeout(()=> setSearch(v), 120);
      });
      clearBtn?.addEventListener('click', ()=> setSearch(''));
      document.addEventListener('keydown', (e)=>{
        if(e.key==='/' && document.activeElement !== searchEl){ e.preventDefault(); searchEl.focus(); }
        else if(e.key==='Escape' && document.activeElement === searchEl){ setSearch(''); searchEl.blur(); }
      });
    }

    /* ===== CSV Export ===== */
    function exportCSV(rows, header, filename='export.csv'){
      const lines = [header.join(',')].concat(
        rows.map(r=> header.map(h=>{
          const v = r[h] ?? r[h.toLowerCase()] ?? '';
          const s = (typeof v==='number') ? v : String(v).replace(/"/g,'""');
          return /[",\n]/.test(s) ? `"${s}"` : s;
        }).join(','))
      );
      const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
      URL.revokeObjectURL(a.href);
      Toast('Exported CSV for current view.');
    }

    /* ===== Filter helpers per tab ===== */
    function filterRows(tabId){
      const q = STATE.q;
      let rows = (DATA[tabId]||[]).slice();

      if(tabId==='gl-je' || tabId==='gl-ledger'){
        // date filter only if dates exist in the tab
        if(STATE.from) rows = rows.filter(r=> r.date>=STATE.from);
        if(STATE.to)   rows = rows.filter(r=> r.date<=STATE.to);
      }

      if(q){
        rows = rows.filter(r=>{
          const hay = Object.values(r).join(' ').toLowerCase();
          return hay.includes(q);
        });
      }
      return rows;
    }

    function totals(rows, fields){
      return fields.reduce((acc,f)=> (acc + (Number(rows.reduce((s,r)=>s + Number(r[f]||0),0))||0)), 0);
    }

    /* ===== Watermark placement/sizing ===== */
    function ensureWMInActiveWrap(){
      const wrap = $('#contentHost .table-wrap'); // first/only visible one
      const wm = $('#printWM');
      if(wrap && wm && wm.parentElement!==wrap){ wrap.appendChild(wm); }
    }
    function sizeWM(){
      const wrap = $('#contentHost .table-wrap');
      const img = $('#printWM img');
      if(!wrap || !img) return;
      const css = getComputedStyle(document.documentElement);
      const scale = parseFloat(css.getPropertyValue('--wm-scale')) || 0.65;
      const maxW = parseFloat(css.getPropertyValue('--wm-max-w')) || 900;
      const w = wrap.getBoundingClientRect().width || 0;
      const target = Math.min(Math.max(260, w * scale), maxW);
      img.style.width = target + 'px';
      img.style.maxHeight = css.getPropertyValue('--wm-max-h');
      img.style.opacity = css.getPropertyValue('--wm-opacity');
    }
    window.addEventListener('beforeprint', ()=>{ ensureWMInActiveWrap(); sizeWM(); });

    /* ===== Renderers per tab ===== */
    function renderJE(){
      const rows = filterRows('gl-je');
      const header = ['date','ref','desc','debit','credit'];
      const totalDebit = rows.reduce((s,r)=>s+Number(r.debit||0),0);
      const totalCredit = rows.reduce((s,r)=>s+Number(r.credit||0),0);
      return `
        <div class="table-wrap overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr>
                <th class="text-left px-3 py-2">Date</th>
                <th class="text-left px-3 py-2">Reference</th>
                <th class="text-left px-3 py-2">Description</th>
                <th class="text-right px-3 py-2">Debit</th>
                <th class="text-right px-3 py-2">Credit</th>
              </tr>
            </thead>
            <tbody>
              ${rows.length ? rows.map(r=>`
                <tr class="border-t">
                  <td class="px-3 py-2">${r.date}</td>
                  <td class="px-3 py-2 font-mono">${r.ref}</td>
                  <td class="px-3 py-2">${r.desc}</td>
                  <td class="px-3 py-2 text-right">${fmtMoney(r.debit, STATE.currency)}</td>
                  <td class="px-3 py-2 text-right">${fmtMoney(r.credit, STATE.currency)}</td>
                </tr>`).join('') :
                `<tr><td colspan="5" class="px-3 py-6"><div class="empty-state">No results. Adjust filters.</div></td></tr>`
              }
            </tbody>
            <tfoot>
              <tr class="border-t bg-slate-50 font-bold">
                <td colspan="3" class="px-3 py-2 text-right">Totals</td>
                <td class="px-3 py-2 text-right">${fmtMoney(totalDebit, STATE.currency)}</td>
                <td class="px-3 py-2 text-right">${fmtMoney(totalCredit, STATE.currency)}</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="mt-3 text-xs text-slate-600">Rows: ${rows.length}. Debits and credits shown in ${STATE.currency}.</div>
        <div id="printWM" class="print-only" aria-hidden="true"><img src="logo.png" alt="Logo watermark"></div>
      `;
    }

    function renderTB(){
      const rows = filterRows('gl-tb');
      const totalDebit = rows.reduce((s,r)=>s+Number(r.debit||0),0);
      const totalCredit= rows.reduce((s,r)=>s+Number(r.credit||0),0);
      return `
        <div class="table-wrap overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr>
                <th class="text-left px-3 py-2">Account</th>
                <th class="text-right px-3 py-2">Debit</th>
                <th class="text-right px-3 py-2">Credit</th>
              </tr>
            </thead>
            <tbody>
              ${rows.length ? rows.map(r=>`
                <tr class="border-t">
                  <td class="px-3 py-2">${r.account}</td>
                  <td class="px-3 py-2 text-right">${fmtMoney(r.debit, STATE.currency)}</td>
                  <td class="px-3 py-2 text-right">${fmtMoney(r.credit, STATE.currency)}</td>
                </tr>`).join('') :
                `<tr><td colspan="3" class="px-3 py-6"><div class="empty-state">No results. Try a different search.</div></td></tr>`
              }
            </tbody>
            <tfoot>
              <tr class="border-t bg-slate-50 font-bold">
                <td class="px-3 py-2 text-right">Totals</td>
                <td class="px-3 py-2 text-right">${fmtMoney(totalDebit, STATE.currency)}</td>
                <td class="px-3 py-2 text-right">${fmtMoney(totalCredit, STATE.currency)}</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="mt-3 text-xs text-slate-600">Trial Balance should balance (Debit = Credit).</div>   
      `;
    }

    function renderLedger(){
      const rows = filterRows('gl-ledger');
      const totalDebit = rows.reduce((s,r)=>s+Number(r.debit||0),0);
      const totalCredit= rows.reduce((s,r)=>s+Number(r.credit||0),0);
      return `
        <div class="table-wrap overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr>
                <th class="text-left px-3 py-2">Date</th>
                <th class="text-left px-3 py-2">Ref</th>
                <th class="text-left px-3 py-2">Description</th>
                <th class="text-right px-3 py-2">Debit</th>
                <th class="text-right px-3 py-2">Credit</th>
                <th class="text-right px-3 py-2">Balance</th>
              </tr>
            </thead>
            <tbody>
              ${rows.length ? rows.map(r=>`
                <tr class="border-t">
                  <td class="px-3 py-2">${r.date}</td>
                  <td class="px-3 py-2 font-mono">${r.ref}</td>
                  <td class="px-3 py-2">${r.desc}</td>
                  <td class="px-3 py-2 text-right">${fmtMoney(r.debit, STATE.currency)}</td>
                  <td class="px-3 py-2 text-right">${fmtMoney(r.credit, STATE.currency)}</td>
                  <td class="px-3 py-2 text-right">${fmtMoney(r.balance, STATE.currency)}</td>
                </tr>`).join('') :
                `<tr><td colspan="6" class="px-3 py-6"><div class="empty-state">No results. Adjust filters.</div></td></tr>`
              }
            </tbody>
            <tfoot>
              <tr class="border-t bg-slate-50 font-bold">
                <td colspan="3" class="px-3 py-2 text-right">Totals</td>
                <td class="px-3 py-2 text-right">${fmtMoney(totalDebit, STATE.currency)}</td>
                <td class="px-3 py-2 text-right">${fmtMoney(totalCredit, STATE.currency)}</td>
                <td class="px-3 py-2 text-right">‚Äî</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="mt-3 text-xs text-slate-600">Balances reflect cumulative movements.</div>
        <div id="printWM" class="print-only" aria-hidden="true"><img src="logo.png" alt="Logo watermark"></div>
      `;
    }

    /* ===== Main view renderer ===== */
    function renderView(tabId){
      const tab = GL_TABS.find(t=>t.id===tabId) || GL_TABS[0];
      markActiveTab(tab.id);

      // build controls + table per tab
      const rows = filterRows(tab.id);
      let bodyHTML = '';
      if(tab.id==='gl-je') bodyHTML = renderJE();
      else if(tab.id==='gl-tb') bodyHTML = renderTB();
      else bodyHTML = renderLedger();

      // date range controls: only where dates exist
      const showDates = (tab.id!=='gl-tb');

      $('#contentHost').innerHTML = `
        <section class="card p-5">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs uppercase tracking-wide text-[var(--muted)]">GENERAL LEDGER</div>
              <h2 class="text-xl font-bold">${tab.label}</h2>
              ${STATE.q ? `<div class="text-xs text-slate-600 mt-1">Filtered by: <span class="font-mono">'${STATE.q}'</span></div>` : ''}
            </div>
            <div class="flex gap-2 no-print">
              <button id="btnExport" class="btn btn-brand">Export CSV</button>
              <button id="btnPrint" class="btn btn-soft">Print</button>
            </div>
          </div>

          <div class="mt-4 border-t border-[var(--ring)] pt-4">
            <div class="mb-3 flex flex-wrap items-end gap-3 no-print">
              ${showDates ? `
              <div>
                <label class="block text-xs font-semibold mb-1">From</label>
                <input id="fFrom" type="date" value="${STATE.from||''}" class="border rounded-md px-2 py-1.5">
              </div>
              <div>
                <label class="block text-xs font-semibold mb-1">To</label>
                <input id="fTo" type="date" value="${STATE.to||''}" class="border rounded-md px-2 py-1.5">
              </div>
              ` : ''}
              <div class="pb-1.5">
                <button id="fApply" class="btn btn-soft">Apply</button>
                <button id="fReset" class="btn btn-soft">Reset</button>
              </div>
            </div>

            ${bodyHTML}
          </div>
        </section>
      `;

      // filters
      $('#fApply')?.addEventListener('click', ()=>{
        STATE.from = $('#fFrom')?.value || '';
        STATE.to   = $('#fTo')?.value || '';
        renderView(tab.id);
      });
      $('#fReset')?.addEventListener('click', ()=>{
        STATE.from = ''; STATE.to = '';
        setSearch(''); // clears search + re-renders
      });

      // export
      $('#btnExport')?.addEventListener('click', ()=>{
        if(tab.id==='gl-je'){
          const rows = filterRows('gl-je');
          const shaped = rows.map(r=>({Date:r.date,Reference:r.ref,Description:r.desc,Debit:r.debit,Credit:r.credit}));
          exportCSV(shaped, ['Date','Reference','Description','Debit','Credit'], 'journal-entries.csv');
        } else if(tab.id==='gl-tb'){
          const rows = filterRows('gl-tb');
          const shaped = rows.map(r=>({Account:r.account,Debit:r.debit,Credit:r.credit}));
          exportCSV(shaped, ['Account','Debit','Credit'], 'trial-balance.csv');
        } else {
          const rows = filterRows('gl-ledger');
          const shaped = rows.map(r=>({Date:r.date,Ref:r.ref,Description:r.desc,Debit:r.debit,Credit:r.credit,Balance:r.balance}));
          exportCSV(shaped, ['Date','Ref','Description','Debit','Credit','Balance'], 'ledger-report.csv');
        }
      });

      // print (fills header and centers watermark on the active table)
      $('#btnPrint')?.addEventListener('click', ()=>{
        const ctx=[];
        if(tab.id!=='gl-tb' && (STATE.from||STATE.to)) ctx.push(`Range: ${STATE.from||'‚Äî'} to ${STATE.to||'‚Äî'}`);
        if(STATE.q) ctx.push(`Search: "${STATE.q}"`);
        $('#printTitle').textContent = `ATIERA ‚Äî General Ledger ‚Äî ${tab.label}`;
        $('#printContext').textContent = ctx.join(' ‚Ä¢ ') || 'All records';
        $('#printWhen').textContent = new Intl.DateTimeFormat(undefined,{year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date());
        ensureWMInActiveWrap();
        sizeWM();
        window.print();
      });

      // move + size watermark now (helps print preview on some browsers)
      ensureWMInActiveWrap();
      sizeWM();
    }

    async function route(){
      const {module, tab} = decodeHash();
      if(module !== 'General Ledger'){ location.hash = '#General%20Ledger/gl-je'; return; }
      await Loader.wrap(new Promise(r=>setTimeout(r,160)));
      renderView(tab);
    }

    window.addEventListener('hashchange', route);

    // initial
    window.addEventListener('DOMContentLoaded', ()=>{
      if(!location.hash) location.hash = '#General%20Ledger/gl-je';
      wireSearch();
      route();
    });
  </script>
</body>
</html>
